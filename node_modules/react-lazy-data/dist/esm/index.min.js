import{useContext as t,useRef as i,useEffect as e,createElement as s}from"react";import{isFunction as r,isFullString as n,isString as o,isBoolean as a}from"is-it-type";import h from"tiny-invariant";import u from"@babel/runtime/helpers/esm/createClass";import{ABORT as c,ON_MOUNT as _,NO_SSR as d}from"react-async-ssr/symbols";import l from"is-promise";import{I as f}from"./constants.min.js";import{v,g as p,S as m,a as y}from"./shared.min.js";import b from"@babel/runtime/helpers/esm/extends";import C from"is-class-component";var g=0,w=1,x=4,S=["string","number","symbol"],j=function(){function t(t,i,e,s,r){var n=this;this._factory=t,this._req=i,this._cacheKey=e,this._context=s,this._parent=r,this._status=r?w:g,this._readStatus=0,this._isDisposed=!1,this._abort=void 0,this._children=[],this._numUndisposedChildren=0;var o=new Promise((function(t){n._resolve=t}));o[c]=this.dispose.bind(this),o[_]=this._mounted.bind(this),t._noSsr&&(o[d]=!0),this._value=o}var i=t.prototype;return i._load=function(){var t=this,i=this._parent;if(i)i._load();else if(this._status===g){var e=(0,this._factory._fetchFn)(this._req);l(e)||h(!1),this._status=w;var s=e.abort;r(s)&&(this._abort=s.bind(e)),e.then((function(i){return t._resolved(i)}),(function(i){return t._rejected(i)}))}},i._resolved=function(t){if(this._status===w){this._resolvedThis(t);for(var i=0,e=this._children;i<e.length;i++){var s=e[i],r=s.child,n=s.prop;this._resolveChild(r,n)}}},i._resolvedThis=function(t){this._status=2,this._value=t,this._abort=void 0,this._resolve()},i._resolveChild=function(t,i){var e=this._value;if(void 0!==i)try{e=e[i]}catch(i){return void t._rejected(i)}t._resolved(e)},i._rejected=function(t){if(this._status===w){this._status=3,this._value=t,this._abort=void 0,this._resolve();for(var i=0,e=this._children;i<e.length;i++){e[i].child._rejected(t)}}},i.read=function(){if(this._validateReadStatus(1),2===this._status)return this._value;throw this._value},i.dispose=function(){if(!this._isDisposed){this._isDisposed=!0;var t=this._parent;if(t)t._disposeFromChild();else{if([g,w].includes(this._status)){this._status=x;var i=this._abort;i&&(this._abort=void 0,i())}var e=this._cacheKey;void 0!==e&&this._factory._clearCacheEntry(e)}}},i.child=function(t){return S.includes(typeof t)||h(!1),this._child(t)},i.clone=function(){return this._child()},i._child=function(t){return this._childWithContext(t,this._context)},i._childWithContext=function(i,e){this._validateReadStatus(2);var s=new t(this._factory,this._req,this._cacheKey,e,this),r=this._status;return 2===r?this._resolveChild(s,i):3===r&&s._rejected(this._value),this._children.push({child:s,prop:i}),this._numUndisposedChildren++,s},i._disposeFromChild=function(){this._numUndisposedChildren--,0===this._numUndisposedChildren&&this.dispose()},i._validateReadStatus=function(t){var i=this._readStatus;0===i?this._readStatus=t:i!==t&&h(!1)},i._mounted=function(t){var i=this._context;i&&i.register(this,t)},u(t,[{key:"isLoading",get:function(){return[g,w,x].includes(this._status)}},{key:"isLoaded",get:function(){return 2===this._status}},{key:"isErrored",get:function(){return 3===this._status}}]),t}();j.prototype[f]=!0;var R="undefined"==typeof window,F=function(){function s(t,i){var e,s,u,c;this._fetchFn=t,null!=i?(v(i),e=i.id,s=i.serialize,u=i.noSsr,null==e?e=void 0:(n(e)||h(!1),null==s?s=!0:!1===s&&h(!1),c=p(i)),null==s||!1===s?s=void 0:!0===s?s=JSON.stringify:(r(s)||h(!1),s=function(t){return function(i){var e=t(i);return o(e)||h(!1),e}}(s)),R&&s&&!e&&h(!1),null==u?u=!1:(a(u)||h(!1),R||(u=!1))):u=!1,this._id=e,this._serialize=s,this._noSsr=u,this._cacheVar=c,R?(this._cache=void 0,this._needContext=!!s):(this._cache=s?{}:void 0,this._needContext=!1)}var u=s.prototype;return u.create=function(t){return this._needContext&&h(!1),this._create(t)},u._create=function(t,i){var e=this._getResource(t,void 0,i);return this._noSsr||e._load(),e},u.use=function(s){if(R){var r=t(m);return!r&&this._needContext&&h(!1),this._create(s,r)}var n=i(),o=n.current;return o&&s===o._req||(o=this._getResource(s,o),n.current=o),e((function(){return o._load(),function(){return o.dispose()}}),[o]),o},u._getResource=function(t,i,e){var s=this._serialize;if(!s)return new j(this,t,void 0,e);var r=s(t);if(i&&i._cacheKey===r)return i;var n=e?e.getCache(this):this._cache,o=n[r];return o||(o=new j(this,t,r),this._populateFromGlobalCache(o,r),n[r]=o),o._childWithContext(void 0,e)},u._clearCacheEntry=function(t){this._cache&&delete this._cache[t]},u._populateFromGlobalCache=function(t,i){if(!R){var e=this._id;if(e){var s=window[this._cacheVar];if(s){var r=s.data;if(r){var n=r[e];if(n&&n.hasOwnProperty(i)){var o=n[i];delete n[i],0===Object.keys(n).length&&delete r[e],t._resolvedThis(o)}}}}}},s}();function O(t,i){return new F(t,i)}function k(t){return null!=t&&!!t[f]&&r(t.read)}function q(t){r(t)||h(!1);var i=C(t)?function(t){return function(i){return i=K(i),s(t,i)}}(t):function(t){return function(i){i=K(i);for(var e=arguments.length,s=new Array(e>1?e-1:0),r=1;r<e;r++)s[r-1]=arguments[r];return t.call.apply(t,[this,i].concat(s))}}(t);return Object.assign(i,t),i.displayName="withResources("+(t.displayName||t.name||"")+")",i}function K(t){for(var i in t=b({},t)){var e=t[i];k(e)&&(t[i]=e.read())}return t}function P(t){return new Promise((function(i){var e=y(t),s=window[e];s?i(s.data):(s=Object.create(null,{data:{configurable:!0,set:function(t){Object.defineProperty(s,"data",{value:t}),i(t)}}}),window[e]=s)}))}export{O as createResourceFactory,k as isResource,P as preloadData,q as withResources};
//# sourceMappingURL=index.min.js.map
