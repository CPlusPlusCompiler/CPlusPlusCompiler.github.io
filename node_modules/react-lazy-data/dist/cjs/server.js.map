{"version":3,"file":"server.js","sources":["../../src/server/server.js"],"sourcesContent":["/* --------------------\n * react-lazy-data module\n * `react-lazy-data/server` entry point\n * Server-side functions\n * ------------------*/\n\n// Modules\nimport {createElement} from 'react';\n\n// Imports\nimport {getCacheVarFromOptionsWithValidate} from '../shared/shared.js';\nimport ServerContext from '../shared/serverContext.js';\n\n// Exports\n\nexport class DataExtractor {\n\tconstructor(options) {\n\t\t// Get cache var from options\n\t\tthis._cacheVar = getCacheVarFromOptionsWithValidate(options);\n\n\t\t// Init data cache\n\t\tthis._cache = {};\n\t}\n\n\tcollectData(children) {\n\t\treturn DataExtractorManager({extractor: this, children});\n\t}\n\n\tgetData() {\n\t\treturn this._cache;\n\t}\n\n\tgetScript(options) {\n\t\t// Get cache var from options, or constructor options\n\t\tconst cacheVar = getCacheVarFromOptionsWithValidate(options, this._cacheVar);\n\n\t\t// Get data\n\t\tconst data = this.getData();\n\n\t\t// Return script tag containing data\n\t\tconst cacheVarStr = jsonify(cacheVar);\n\t\treturn `<script>(window[${cacheVarStr}]=window[${cacheVarStr}]||{}).data=${jsonify(data)}</script>`;\n\t}\n}\n\nclass Ctx {\n\tconstructor(extractor) {\n\t\tthis._cache = {};\n\t\tthis._ssrCache = extractor._cache;\n\t}\n\n\tgetCache(factory) {\n\t\t// Get factory ID\n\t\tconst id = factory._id;\n\t\tif (!id) return undefined;\n\n\t\treturn getValuesCache(this._cache, id);\n\t}\n\n\tregister(resource, willRender) {\n\t\t// If will not render, exit - data is not needed\n\t\tif (!willRender) return;\n\n\t\t// Get factory ID\n\t\tconst id = resource._factory._id;\n\t\tif (!id) return;\n\n\t\t// Get master resource\n\t\twhile (true) { // eslint-disable-line no-constant-condition\n\t\t\tconst parent = resource._parent;\n\t\t\tif (!parent) break;\n\t\t\tresource = parent;\n\t\t}\n\n\t\t// Save data from resource to cache\n\t\tconst valuesCache = getValuesCache(this._ssrCache, id);\n\t\tvaluesCache[resource._cacheKey] = resource._value;\n\t}\n}\n\nexport function DataExtractorManager({extractor, children}) {\n\treturn createElement(\n\t\tServerContext.Provider,\n\t\t{value: new Ctx(extractor), children}\n\t);\n}\n\n/*\n * Helper functions\n */\nfunction getValuesCache(cache, id) {\n\tlet valuesCache = cache[id];\n\tif (!valuesCache) {\n\t\tvaluesCache = {};\n\t\tcache[id] = valuesCache;\n\t}\n\treturn valuesCache;\n}\n\n/**\n * Convert to JSON for inclusion in HTML.\n * Like `JSON.stringify()` except escapes '</' to avoid XSS vulnerability\n * if data contains e.g. `</script><script>evil()</script>`.\n * https://sophiebits.com/2012/08/03/preventing-xss-json.html\n * @param {*} input - Input (any type)\n * @returns {string} - JSON string\n */\nfunction jsonify(input) {\n\treturn JSON.stringify(input).replace(/<\\//g, '<\\\\/');\n}\n"],"names":["DataExtractor","constructor","options","_cacheVar","getCacheVarFromOptionsWithValidate","_cache","collectData","children","DataExtractorManager","extractor","getData","getScript","cacheVar","data","cacheVarStr","jsonify","Ctx","_ssrCache","getCache","factory","id","_id","undefined","getValuesCache","register","resource","willRender","_factory","parent","_parent","valuesCache","_cacheKey","_value","createElement","ServerContext","Provider","value","cache","input","JSON","stringify","replace"],"mappings":";;;;;;;;;;AAAA;;;;;;AAeO,MAAMA,aAAN,CAAoB;AAC1BC,EAAAA,WAAW,CAACC,OAAD,EAAU;AACpB;AACA,SAAKC,SAAL,GAAiBC,yCAAkC,CAACF,OAAD,CAAnD,CAFoB;;AAKpB,SAAKG,MAAL,GAAc,EAAd;AACA;;AAEDC,EAAAA,WAAW,CAACC,QAAD,EAAW;AACrB,WAAOC,oBAAoB,CAAC;AAACC,MAAAA,SAAS,EAAE,IAAZ;AAAkBF,MAAAA;AAAlB,KAAD,CAA3B;AACA;;AAEDG,EAAAA,OAAO,GAAG;AACT,WAAO,KAAKL,MAAZ;AACA;;AAEDM,EAAAA,SAAS,CAACT,OAAD,EAAU;AAClB;AACA,UAAMU,QAAQ,GAAGR,yCAAkC,CAACF,OAAD,EAAU,KAAKC,SAAf,CAAnD,CAFkB;;AAKlB,UAAMU,IAAI,GAAG,KAAKH,OAAL,EAAb,CALkB;;AAQlB,UAAMI,WAAW,GAAGC,OAAO,CAACH,QAAD,CAA3B;AACA,WAAQ,mBAAkBE,WAAY,YAAWA,WAAY,eAAcC,OAAO,CAACF,IAAD,CAAO,WAAzF;AACA;;AA3ByB;;AA8B3B,MAAMG,GAAN,CAAU;AACTf,EAAAA,WAAW,CAACQ,SAAD,EAAY;AACtB,SAAKJ,MAAL,GAAc,EAAd;AACA,SAAKY,SAAL,GAAiBR,SAAS,CAACJ,MAA3B;AACA;;AAEDa,EAAAA,QAAQ,CAACC,OAAD,EAAU;AACjB;AACA,UAAMC,EAAE,GAAGD,OAAO,CAACE,GAAnB;AACA,QAAI,CAACD,EAAL,EAAS,OAAOE,SAAP;AAET,WAAOC,cAAc,CAAC,KAAKlB,MAAN,EAAce,EAAd,CAArB;AACA;;AAEDI,EAAAA,QAAQ,CAACC,QAAD,EAAWC,UAAX,EAAuB;AAC9B;AACA,QAAI,CAACA,UAAL,EAAiB,OAFa;;AAK9B,UAAMN,EAAE,GAAGK,QAAQ,CAACE,QAAT,CAAkBN,GAA7B;AACA,QAAI,CAACD,EAAL,EAAS,OANqB;;AAS9B,WAAO,IAAP,EAAa;AAAE;AACd,YAAMQ,MAAM,GAAGH,QAAQ,CAACI,OAAxB;AACA,UAAI,CAACD,MAAL,EAAa;AACbH,MAAAA,QAAQ,GAAGG,MAAX;AACA,KAb6B;;;AAgB9B,UAAME,WAAW,GAAGP,cAAc,CAAC,KAAKN,SAAN,EAAiBG,EAAjB,CAAlC;AACAU,IAAAA,WAAW,CAACL,QAAQ,CAACM,SAAV,CAAX,GAAkCN,QAAQ,CAACO,MAA3C;AACA;;AAhCQ;;AAmCH,SAASxB,oBAAT,CAA8B;AAACC,EAAAA,SAAD;AAAYF,EAAAA;AAAZ,CAA9B,EAAqD;AAC3D,SAAO0B,mBAAa,CACnBC,oBAAa,CAACC,QADK,EAEnB;AAACC,IAAAA,KAAK,EAAE,IAAIpB,GAAJ,CAAQP,SAAR,CAAR;AAA4BF,IAAAA;AAA5B,GAFmB,CAApB;AAIA;AAED;;;;AAGA,SAASgB,cAAT,CAAwBc,KAAxB,EAA+BjB,EAA/B,EAAmC;AAClC,MAAIU,WAAW,GAAGO,KAAK,CAACjB,EAAD,CAAvB;;AACA,MAAI,CAACU,WAAL,EAAkB;AACjBA,IAAAA,WAAW,GAAG,EAAd;AACAO,IAAAA,KAAK,CAACjB,EAAD,CAAL,GAAYU,WAAZ;AACA;;AACD,SAAOA,WAAP;AACA;AAED;;;;;;;;;;AAQA,SAASf,OAAT,CAAiBuB,KAAjB,EAAwB;AACvB,SAAOC,IAAI,CAACC,SAAL,CAAeF,KAAf,EAAsBG,OAAtB,CAA8B,MAA9B,EAAsC,MAAtC,CAAP;AACA;;;;;"}