"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),i=require("is-it-type"),r=t(require("tiny-invariant")),s=t(require("@babel/runtime/helpers/createClass")),n=require("react-async-ssr/symbols"),o=t(require("is-promise")),a=require("./constants.min.js"),h=require("./shared.min.js"),u=t(require("@babel/runtime/helpers/extends")),c=t(require("is-class-component")),_=0,d=1,l=4,f=["string","number","symbol"],v=function(){function t(t,e,i,r,s){var o=this;this._factory=t,this._req=e,this._cacheKey=i,this._context=r,this._parent=s,this._status=s?d:_,this._readStatus=0,this._isDisposed=!1,this._abort=void 0,this._children=[],this._numUndisposedChildren=0;var a=new Promise((function(t){o._resolve=t}));a[n.ABORT]=this.dispose.bind(this),a[n.ON_MOUNT]=this._mounted.bind(this),t._noSsr&&(a[n.NO_SSR]=!0),this._value=a}var e=t.prototype;return e._load=function(){var t=this,e=this._parent;if(e)e._load();else if(this._status===_){var s=(0,this._factory._fetchFn)(this._req);o(s)||r(!1),this._status=d;var n=s.abort;i.isFunction(n)&&(this._abort=n.bind(s)),s.then((function(e){return t._resolved(e)}),(function(e){return t._rejected(e)}))}},e._resolved=function(t){if(this._status===d){this._resolvedThis(t);for(var e=0,i=this._children;e<i.length;e++){var r=i[e],s=r.child,n=r.prop;this._resolveChild(s,n)}}},e._resolvedThis=function(t){this._status=2,this._value=t,this._abort=void 0,this._resolve()},e._resolveChild=function(t,e){var i=this._value;if(void 0!==e)try{i=i[e]}catch(e){return void t._rejected(e)}t._resolved(i)},e._rejected=function(t){if(this._status===d){this._status=3,this._value=t,this._abort=void 0,this._resolve();for(var e=0,i=this._children;e<i.length;e++){i[e].child._rejected(t)}}},e.read=function(){if(this._validateReadStatus(1),2===this._status)return this._value;throw this._value},e.dispose=function(){if(!this._isDisposed){this._isDisposed=!0;var t=this._parent;if(t)t._disposeFromChild();else{if([_,d].includes(this._status)){this._status=l;var e=this._abort;e&&(this._abort=void 0,e())}var i=this._cacheKey;void 0!==i&&this._factory._clearCacheEntry(i)}}},e.child=function(t){return f.includes(typeof t)||r(!1),this._child(t)},e.clone=function(){return this._child()},e._child=function(t){return this._childWithContext(t,this._context)},e._childWithContext=function(e,i){this._validateReadStatus(2);var r=new t(this._factory,this._req,this._cacheKey,i,this),s=this._status;return 2===s?this._resolveChild(r,e):3===s&&r._rejected(this._value),this._children.push({child:r,prop:e}),this._numUndisposedChildren++,r},e._disposeFromChild=function(){this._numUndisposedChildren--,0===this._numUndisposedChildren&&this.dispose()},e._validateReadStatus=function(t){var e=this._readStatus;0===e?this._readStatus=t:e!==t&&r(!1)},e._mounted=function(t){var e=this._context;e&&e.register(this,t)},s(t,[{key:"isLoading",get:function(){return[_,d,l].includes(this._status)}},{key:"isLoaded",get:function(){return 2===this._status}},{key:"isErrored",get:function(){return 3===this._status}}]),t}();v.prototype[a.IS_RESOURCE]=!0;var p="undefined"==typeof window,y=function(){function t(t,e){var s,n,o,a;this._fetchFn=t,null!=e?(h.validateOptions(e),s=e.id,n=e.serialize,o=e.noSsr,null==s?s=void 0:(i.isFullString(s)||r(!1),null==n?n=!0:!1===n&&r(!1),a=h.getCacheVarFromOptions(e)),null==n||!1===n?n=void 0:!0===n?n=JSON.stringify:(i.isFunction(n)||r(!1),n=function(t){return function(e){var s=t(e);return i.isString(s)||r(!1),s}}(n)),p&&n&&!s&&r(!1),null==o?o=!1:(i.isBoolean(o)||r(!1),p||(o=!1))):o=!1,this._id=s,this._serialize=n,this._noSsr=o,this._cacheVar=a,p?(this._cache=void 0,this._needContext=!!n):(this._cache=n?{}:void 0,this._needContext=!1)}var s=t.prototype;return s.create=function(t){return this._needContext&&r(!1),this._create(t)},s._create=function(t,e){var i=this._getResource(t,void 0,e);return this._noSsr||i._load(),i},s.use=function(t){if(p){var i=e.useContext(h.ServerContext);return!i&&this._needContext&&r(!1),this._create(t,i)}var s=e.useRef(),n=s.current;return n&&t===n._req||(n=this._getResource(t,n),s.current=n),e.useEffect((function(){return n._load(),function(){return n.dispose()}}),[n]),n},s._getResource=function(t,e,i){var r=this._serialize;if(!r)return new v(this,t,void 0,i);var s=r(t);if(e&&e._cacheKey===s)return e;var n=i?i.getCache(this):this._cache,o=n[s];return o||(o=new v(this,t,s),this._populateFromGlobalCache(o,s),n[s]=o),o._childWithContext(void 0,i)},s._clearCacheEntry=function(t){this._cache&&delete this._cache[t]},s._populateFromGlobalCache=function(t,e){if(!p){var i=this._id;if(i){var r=window[this._cacheVar];if(r){var s=r.data;if(s){var n=s[i];if(n&&n.hasOwnProperty(e)){var o=n[e];delete n[e],0===Object.keys(n).length&&delete s[i],t._resolvedThis(o)}}}}}},t}();function C(t){return null!=t&&!!t[a.IS_RESOURCE]&&i.isFunction(t.read)}function m(t){for(var e in t=u({},t)){var i=t[e];C(i)&&(t[e]=i.read())}return t}exports.createResourceFactory=function(t,e){return new y(t,e)},exports.isResource=C,exports.preloadData=function(t){return new Promise((function(e){var i=h.getCacheVarFromOptionsWithValidate(t),r=window[i];r?e(r.data):(r=Object.create(null,{data:{configurable:!0,set:function(t){Object.defineProperty(r,"data",{value:t}),e(t)}}}),window[i]=r)}))},exports.withResources=function(t){i.isFunction(t)||r(!1);var s=c(t)?function(t){return function(i){return i=m(i),e.createElement(t,i)}}(t):function(t){return function(e){e=m(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return t.call.apply(t,[this,e].concat(r))}}(t);return Object.assign(s,t),s.displayName="withResources("+(t.displayName||t.name||"")+")",s};
//# sourceMappingURL=index.min.js.map
