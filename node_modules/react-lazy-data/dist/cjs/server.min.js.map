{"version":3,"file":"server.min.js","sources":["../../src/server/server.js"],"sourcesContent":["/* --------------------\n * react-lazy-data module\n * `react-lazy-data/server` entry point\n * Server-side functions\n * ------------------*/\n\n// Modules\nimport {createElement} from 'react';\n\n// Imports\nimport {getCacheVarFromOptionsWithValidate} from '../shared/shared.js';\nimport ServerContext from '../shared/serverContext.js';\n\n// Exports\n\nexport class DataExtractor {\n\tconstructor(options) {\n\t\t// Get cache var from options\n\t\tthis._cacheVar = getCacheVarFromOptionsWithValidate(options);\n\n\t\t// Init data cache\n\t\tthis._cache = {};\n\t}\n\n\tcollectData(children) {\n\t\treturn DataExtractorManager({extractor: this, children});\n\t}\n\n\tgetData() {\n\t\treturn this._cache;\n\t}\n\n\tgetScript(options) {\n\t\t// Get cache var from options, or constructor options\n\t\tconst cacheVar = getCacheVarFromOptionsWithValidate(options, this._cacheVar);\n\n\t\t// Get data\n\t\tconst data = this.getData();\n\n\t\t// Return script tag containing data\n\t\tconst cacheVarStr = jsonify(cacheVar);\n\t\treturn `<script>(window[${cacheVarStr}]=window[${cacheVarStr}]||{}).data=${jsonify(data)}</script>`;\n\t}\n}\n\nclass Ctx {\n\tconstructor(extractor) {\n\t\tthis._cache = {};\n\t\tthis._ssrCache = extractor._cache;\n\t}\n\n\tgetCache(factory) {\n\t\t// Get factory ID\n\t\tconst id = factory._id;\n\t\tif (!id) return undefined;\n\n\t\treturn getValuesCache(this._cache, id);\n\t}\n\n\tregister(resource, willRender) {\n\t\t// If will not render, exit - data is not needed\n\t\tif (!willRender) return;\n\n\t\t// Get factory ID\n\t\tconst id = resource._factory._id;\n\t\tif (!id) return;\n\n\t\t// Get master resource\n\t\twhile (true) { // eslint-disable-line no-constant-condition\n\t\t\tconst parent = resource._parent;\n\t\t\tif (!parent) break;\n\t\t\tresource = parent;\n\t\t}\n\n\t\t// Save data from resource to cache\n\t\tconst valuesCache = getValuesCache(this._ssrCache, id);\n\t\tvaluesCache[resource._cacheKey] = resource._value;\n\t}\n}\n\nexport function DataExtractorManager({extractor, children}) {\n\treturn createElement(\n\t\tServerContext.Provider,\n\t\t{value: new Ctx(extractor), children}\n\t);\n}\n\n/*\n * Helper functions\n */\nfunction getValuesCache(cache, id) {\n\tlet valuesCache = cache[id];\n\tif (!valuesCache) {\n\t\tvaluesCache = {};\n\t\tcache[id] = valuesCache;\n\t}\n\treturn valuesCache;\n}\n\n/**\n * Convert to JSON for inclusion in HTML.\n * Like `JSON.stringify()` except escapes '</' to avoid XSS vulnerability\n * if data contains e.g. `</script><script>evil()</script>`.\n * https://sophiebits.com/2012/08/03/preventing-xss-json.html\n * @param {*} input - Input (any type)\n * @returns {string} - JSON string\n */\nfunction jsonify(input) {\n\treturn JSON.stringify(input).replace(/<\\//g, '<\\\\/');\n}\n"],"names":["Ctx","constructor","extractor","_cache","_ssrCache","getCache","factory","id","_id","getValuesCache","this","register","resource","willRender","_factory","parent","_parent","_cacheKey","_value","DataExtractorManager","children","createElement","ServerContext","Provider","value","cache","valuesCache","jsonify","input","JSON","stringify","replace","options","_cacheVar","getCacheVarFromOptionsWithValidate","collectData","getData","getScript","cacheVar","data","cacheVarStr"],"mappings":"0MA6CA,MAAMA,EACLC,YAAYC,QACNC,OAAS,QACTC,UAAYF,EAAUC,OAG5BE,SAASC,SAEFC,EAAKD,EAAQE,OACdD,SAEEE,EAAeC,KAAKP,OAAQI,GAGpCI,SAASC,EAAUC,OAEbA,EAAY,aAGXN,EAAKK,EAASE,SAASN,OACxBD,UAGQ,OACNQ,EAASH,EAASI,YACnBD,EAAQ,MACbH,EAAWG,EAIQN,EAAeC,KAAKN,UAAWG,GACvCK,EAASK,WAAaL,EAASM,SAItC,SAASC,GAAqBjB,UAACA,EAADkB,SAAYA,WACzCC,gBACNC,gBAAcC,SACd,CAACC,MAAO,IAAIxB,EAAIE,GAAYkB,SAAAA,IAO9B,SAASX,EAAegB,EAAOlB,OAC1BmB,EAAcD,EAAMlB,UACnBmB,IACJA,EAAc,GACdD,EAAMlB,GAAMmB,GAENA,EAWR,SAASC,EAAQC,UACTC,KAAKC,UAAUF,GAAOG,QAAQ,OAAQ,8BA7FvC,MACN9B,YAAY+B,QAENC,UAAYC,qCAAmCF,QAG/C7B,OAAS,GAGfgC,YAAYf,UACJD,EAAqB,CAACjB,UAAWQ,KAAMU,SAAAA,IAG/CgB,iBACQ1B,KAAKP,OAGbkC,UAAUL,SAEHM,EAAWJ,qCAAmCF,EAAStB,KAAKuB,WAG5DM,EAAO7B,KAAK0B,UAGZI,EAAcb,EAAQW,SACpB,mBAAkBE,aAAuBA,gBAA0Bb,EAAQY"}